@page "/list"
@using Tobiso.Web.Shared.Interfaces
@using Tobiso.Web.Shared.DTOs
@inject ITobisoAnonymApi Api
@inject NavigationManager Navigation
@inject ILogger<List> Logger

<PageTitle>Home - Posts</PageTitle>

<h1>Posts</h1>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger" role="alert">
        <strong>Error:</strong> @errorMessage
    </div>
}

@if (posts == null)
{
    <p>Loading posts...</p>
}
else if (!posts.Any())
{
    <p>No posts found.</p>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th scope="col">ID</th>
                    <th scope="col">Title</th>
                    <th scope="col">Category</th>
                    <th scope="col">File Path</th>
                    <th scope="col">Updated</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var post in posts)
                {
                    <tr>
                        <td>@post.Id</td>
                        <td>
                            <strong>
                                <a href="/post/@post.Id" class="text-decoration-none">@post.Title</a>
                            </strong>
                        </td>
                        <td>
                            @if (post.CategoryId.HasValue)
                            {
                                var categoryName = GetCategoryNameById(post.CategoryId.Value);
                                if (!string.IsNullOrEmpty(categoryName))
                                {
                                    <span class="badge bg-primary">@categoryName</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            @if (!string.IsNullOrEmpty(post.FilePath))
                            {
                                <code class="text-break">@post.FilePath</code>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            @if (post.UpdatedAt.HasValue)
                            {
                                <small>@post.UpdatedAt.Value.ToString("MMM dd, yyyy HH:mm")</small>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="mt-3">
        <p class="text-muted">
            <i class="bi bi-info-circle"></i>
            Total posts: <strong>@posts.Count</strong>
        </p>
    </div>

    @if (categories.Any())
    {
        <h2>Categories</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var category in categories)
                {
                    <tr>
                        <td>@category.Id</td>
                        <td>@category.Name</td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@code {
    private IList<PostResponse>? posts;
    private List<CategoryResponse> categories = new List<CategoryResponse>();
    private Dictionary<int, string> categoryNames = new Dictionary<int, string>();
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadPosts();
        await LoadCategories();
    }

    private async Task LoadPosts()
    {
        try
        {
            Logger.LogInformation("Starting to load posts from API");

            posts = await Api.GetAllPosts();

            Logger.LogInformation("Successfully loaded {PostCount} posts", posts.Count);

            StateHasChanged();
        }
        catch (Refit.ApiException ex)
        {
            Logger.LogWarning("Api error while loading posts: {Message}", ex.Message);
            errorMessage = $"Error loading posts: {ex.Message}";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading posts: {ex.Message}";
            Logger.LogError(ex, "Exception occurred while loading posts: {Message}", ex.Message);
        }
    }

    private async Task LoadCategories()
    {
        try
        {
            Logger.LogInformation("Starting to load categories from API");

            var loadedCategories = await Api.GetAllCategories();
            if (loadedCategories != null)
            {
                categories = loadedCategories;
                categoryNames = categories.ToDictionary(c => c.Id, c => c.Name);
                Logger.LogInformation("Successfully loaded {CategoryCount} categories", categories.Count);
            }
            StateHasChanged();
        }
        catch (Refit.ApiException ex) when (ex.StatusCode == System.Net.HttpStatusCode.InternalServerError)
        {
            Logger.LogWarning("Server error while loading categories (500 Internal Server Error)");
            // Don't show categories error to user as it's not critical for viewing posts
            // Keep categories as empty list
        }
        catch (Refit.ApiException ex)
        {
            Logger.LogWarning("Api error while loading categories: {StatusCode} - {Message}", ex.StatusCode, ex.Message);
            // Don't show categories error to user as it's not critical for viewing posts
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Exception occurred while loading categories: {Message}", ex.Message);
            // Don't show categories error to user as it's not critical for viewing posts
        }
    }

    private string? GetCategoryNameById(int categoryId)
    {
        return categoryNames.TryGetValue(categoryId, out var name) ? name : null;
    }

    [Inject]
    private IJSRuntime JS { get; set; } = default!;

    private async Task<bool> JsConfirm(string message)
    {
        return await JS.InvokeAsync<bool>("confirm", message);
    }
}